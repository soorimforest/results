00 코드 정리: 원재료 통계량 계산

원재료 통계량 계산 및 데이터 전처리 통합 스크립트

실행 순서:
1. 각 열의 평균값 산출 (cleaned_data_preprocessed.xlsx)
2. 원재료별 평균값 계산 (원재료별_평균값.xlsx)
3. 원재료별 분산값 계산 (원재료별_분산값.xlsx)
4. 원재료별 표준편차값 계산 (원재료별_표준편차값.xlsx)
5. 원재료_3과 원재료_4의 8:2 가중 평균 계산 (원재료_3_4_가중평균_CoA.xlsx)
6. Train/Test 분할 (train_83.xlsx, test_20.xlsx)

01 코드: 특징 행렬 정리
기본 고급 특징 추출 (전구체별 통계량, 8:2 혼합 특징, BET, 입경 분포 등)
이상치 처리 후 특징 행렬에 원재료 통계량 추가 (평균, 분산, 표준편차)
가중 평균 특징 추가 (원재료_3과 원재료_4의 8:2 가중 평균)


03 코드 : 탐색적 데이터 분석
역할: 데이터 탐색적 분석으로 특징과 타겟 간 관계 파악
(!) 상관 분석: Pearson 상관계수로 특징(X)과 품질 지표(Y) 간 관계 계산
상관관계가 높은 특징 식별
출력: data/exploratory_analysis/correlation_analysis.csv
(2) 산포 분석: 표준편차, IQR 감소 가능성 분석
평균 대비 변동성 평가
출력: data/exploratory_analysis/dispersion_analysis.csv
(3) 시각화: 히스토그램 (분포 확인), CDF (누적 분포 함수), 박스플롯 (이상치 및 분포 확인)
출력: data/exploratory_analysis/visualizations/ (PNG 파일들)

입력: data/outlier_detection/feature_matrix_after_outliers.csv (02 코드에서 생성된 이상치 처리 후 특징 행렬)
출력: correlation_analysis.csv (상관관계 분석 결과)
dispersion_analysis.csv (산포 분석 결과)
visualizations/ (그래프들)

04 코드 : 모델 학습 (5개 모델: RF, XGBoost 기본, XGBoost 기본 튜닝, XGBoost 정밀 튜닝, H2O AutoML)


05 코드: 

# 01번
py 01_build_features.py

# 01번 완료 후 02번
py 02_detect_outliers_multiple_methods.py

# 02번 완료 후 03번
py 03_exploratory_analysis.py

# 03번 완료 후 04번
py 04_train_models.py

# 버전 1: 결측치 99% 이상 제거 + Median 보간
py 04_train_models_remove_99pct_median.py

# 버전 2: 결측치 99% 이상 제거 + Mean(산술평균) 보간
py 04_train_models_remove_99pct_mean.py

# 04번 완료 후 05번
py 05_dispersion_analysis_optimization.py

# 05번 완료 후 06번
py 06_split_train_valid_test.py

버전 1: 결측치 99% 이상 특징 제거 + Median 보간
현재 방식 유지
안정적이고 검증됨

버전 2: 결측치 99% 이상 특징 제거 + Mean 보간
Mean으로 변경하여 성능 비교
이상치가 적은 특징에서는 Mean이 더 적합할 수 있음
어떤 평균값을 사용할까요?
Mean (산술평균)
Median (중앙값) - 현재 방식
둘 다 만들어서 비교



# results 02
탐색적 분석 결과 요약
1. 산포 분석 결과
변동성이 높은 타겟 (감소 가능성 높음)
자성이물(ICP, SDI)-Fe
CV: 0.730 (73%)
IQR 비율: 0.949 (95%)
해석: 변동성이 매우 높아 추가 최적화 여지가 큼
이상치 처리 효과: 표준편차 60% 감소
자성이물(ICP, SDI)-합계
CV: 0.703 (70%)
IQR 비율: 0.959 (96%)
해석: 변동성이 매우 높음
이상치 처리 효과: 표준편차 67% 감소
자성이물(ICP, SDI)-Cr
CV: 0.340 (34%)
IQR 비율: 0.623 (62%)
해석: 변동성이 높음
이상치 처리 효과: 표준편차 85% 감소
불순물-Si
CV: 0.246 (25%)
IQR 비율: 0.344 (34%)
해석: 변동성이 높음
이상치 처리 효과: 표준편차 23% 감소
CDS 수축율
CV: 0.538 (54%)
IQR 비율: 0.789 (79%)
해석: 변동성이 매우 높음
변동성이 낮은 타겟 (이미 안정적)
조성 관련 (Li, Ni, Co, Mn, Zr): CV 0.001~0.033 (0.1~3.3%)
입도 관련 (Dmin, D10, D50, D90): CV 0.006~0.018 (0.6~1.8%)
XRD 관련: CV 0.0001~0.018 (0.01~1.8%)
해석: 이미 변동성이 낮아 추가 감소 여지가 작음. 이상치 처리로 17~35% 감소는 달성됨.
2. 상관관계 분석 결과
매우 높은 상관관계 (|r| > 0.95)
입도 관련 특징들
입도-Dmax ↔ 입도-1㎛ 이하: -0.999
입도-D10 ↔ 입도-1㎛ 이하: -0.997
해석: 입도 분포 특징 간 강한 관계
자성이물 관련 특징들
자성이물-Cr ↔ 입도-1㎛ 이하: 0.999
자성이물-합계 ↔ 입도-1㎛ 이하: 0.992
해석: 입도와 자성이물 함량 간 강한 관계
XRD 관련 특징들
XRD-Ni Occ. ↔ SPAN: 0.999
XRD-Cry.Size ↔ 조성-Ni: 0.999
해석: XRD 결과와 입도/조성 간 강한 관계
높은 상관관계 (0.8 < |r| < 0.95)
조성-Ni ↔ 잔류리튬-Li2CO3: -0.943
조성-Zr ↔ 자성이물-Cr: -0.946
입도-D10 ↔ BET-BET: 0.936
입도-D10 ↔ 불순물-Na: -0.959
XRD-Lattice a ↔ 입도-D90: -0.950
종합 해석
주요 발견
자성이물 관련 타겟
변동성이 매우 높음 (CV 34~73%)
입도와 강한 상관관계 (r > 0.99)
이상치 처리로 표준편차 60~85% 감소
결론: 추가 최적화 여지가 크고, 입도 특징이 예측에 유용
조성 관련 타겟
변동성이 낮음 (CV 0.1~3.3%)
XRD, 잔류리튬과 강한 상관관계
결론: 이미 안정적이며, XRD/잔류리튬 특징이 유용
입도 관련 타겟
변동성이 낮음 (CV 0.6~1.8%)
자성이물, BET, 불순물과 강한 상관관계
결론: 이미 안정적이며, 자성이물/BET 특징이 유용
모델 학습에 대한 시사점
추천 특징 선택 우선순위
1순위: 입도 관련 특징
상관계수가 높고 물리적 의미가 명확
자성이물, BET, 불순물과 강한 관계
2순위: 자성이물 관련 특징
변동성이 크지만 타겟과 강한 관계
입도와 밀접한 연관
3순위: XRD 관련 특징
결정 구조 정보 제공
조성, 입도와 강한 관계
4순위: 원재료 통계량 특징 (새로 추가)
원재료 변동성 정보 제공
모델 성능 향상에 기여 가능
주의사항
상관계수 0.95 이상 특징: 중복 가능성 높음 → Feature 선택 시 중복 제거 필요
샘플 수가 적은 타겟 (n < 10): 상관계수 해석 주의
결론
성공적인 부분
이상치 처리 효과: 대부분 타겟에서 표준편차 20~85% 감소
강한 상관관계 발견: 입도, 자성이물, XRD 관련 특징들이 타겟과 강한 관계
변동성 파악: 자성이물 관련 타겟의 높은 변동성 확인
개선 가능한 부분
일부 타겟 (불순물-Na): 이상치 처리 효과가 낮음
특징 선택: 상관계수 기반으로 더 엄격한 특징 선택 필요
다음 단계 권장사항
강한 상관관계 특징 우선 선택: 상위 20~30개 특징
중복 제거: 상관계수 0.90 이상 특징 제거
원재료 통계량 특징 활용: 새로 추가한 특징으로 모델 학습
---------------------------------------------------------

#04 결과

탐색적 분석 결과 해석을 정리했습니다. 주요 내용 요약:
주요 발견사항
1. 상관 분석 결과
매우 높은 상관관계 (|r| > 0.95):
입도 분포 특징들 간 강한 상관: 미세 입자 비율 ↑ → 최대 입도 ↓
XRD 결정 크기 ↔ 원재료_4의 Ni 조성: r = 0.999 (거의 완벽한 상관)
자성 불순물 ↔ 입도 분포: 미세 입자 비율 ↑ → 자성 불순물 ↑
예측 가능성이 높은 타겟:
불순물-Na: 원재료 Na, 입도, 투입량과 강한 상관 (r > 0.84)
BET 표면적: 입도 분포와 강한 상관 (r > 0.93)
XRD 결정 크기: 조성-Ni와 거의 완벽한 상관
2. 산포 분석 결과
변동성이 매우 높은 타겟 (최적화 최우선):
자성이물(ICP, SDI)-Fe: CV = 73% (변동성 매우 높음)
자성이물(ICP, SDI)-합계: CV = 70%
불순물-Si: CV = 24.6%
불순물-Na: CV = 14.8%
이미 안정적인 타겟 (추가 최적화 불필요):
조성-Li, Ni, Co, Mn: CV < 0.01 (매우 안정적)
입도 분포: CV < 0.02 (안정적)
XRD 격자 상수: CV < 0.0001 (매우 안정적)
3. 모델 학습 전략
핵심 특징 (공통 사용 권장):
입도 분포 특징 (D10, D90, Dmax, 1㎛ 이하)
원재료 조성 특징 (Ni, Mn, Co)
불순물 특징 (Na, 자성 불순물)
투입량 특징 (투입량_3_1, 투입량_4_1)
예상 성능:
높은 성능 예상: 불순물-Na, BET-BET, XRD 결정 크기
보통 성능 예상: 자성 불순물, 불순물-Si
낮은 성능 예상: 이미 안정적인 조성 타겟들

-------------------------------

TRAIN 83 TEST 20

실행 순서 (번호 순서대로)
00_calculate_material_averages_final.py - 원재료 평균값 계산
00_calculate_material_variance.py - 원재료 분산값 계산
00_calculate_material_std.py - 원재료 표준편차값 계산
01_build_features_coa_data_advanced.py - 기본 특징 추출
02_detect_outliers_multiple_methods.py - 이상치 탐지 및 전처리
01_add_material_statistics_features.py - 원재료 통계량 특징 추가
00_calculate_material_3_4_weighted_coa.py - 원재료_3과 원재료_4의 8:2 가중 평균 계산
01_add_weighted_coa_features.py - 가중 평균 특징 추가
03_exploratory_analysis.py - 탐색적 분석 (선택사항)
04_train_models_improved.py - 모델 학습


--------------------

06 코드 실행 결과 분석 요약:
전체 요약
분석된 타겟: 9개
평균 R²: 0.7995
중앙값 R²: 0.8630
최고 R²: 0.9998 (불순물-Si)
최저 R²: 0.3337 (불순물-Ca)
그룹별 분석
1. 불순물(impurity) 그룹 (3개)
평균 R²: 0.7771
타겟:
불순물-Na: R² = 0.9977
불순물-Ca: R² = 0.3337
불순물-Si: R² = 0.9998
2. XRD 그룹 (2개)
평균 R²: 0.8534
타겟:
XRD-Ni Occ. (보정): R² = 0.8439
XRD-Ni Occ.: R² = 0.8630
3. 기타(other) 그룹 (4개)
평균 R²: 0.7894
타겟:
자성이물-Fe: R² = 0.8407
자성이물-Cr: R² = 0.4545
자성이물-합계: R² = 0.8663
CDS 수축율: R² = 0.9958
주요 발견
1. 최적 피팅 함수
모든 타겟에서 ML_GradientBoosting이 최적 함수로 선택됨
ML 기반 함수가 파라미터 기반 함수보다 성능이 우수함
2. 피팅 함수 성능 순위 (평균 R² 기준)
ML_GradientBoosting: 0.7995 (9개 타겟)
ML_RandomForest: 0.6523 (9개 타겟)
Rational_8param: 0.3291 (7개 타겟)
Sine_5param: 0.2556 (7개 타겟)
ML_Polynomial_4param: 0.2129 (9개 타겟)
3. 타겟별 특징
고성능 타겟 (R² > 0.9): 불순물-Na, 불순물-Si, CDS 수축율
중간 성능 (R² 0.4~0.9): 자성이물-Fe, 자성이물-합계, XRD 타겟들
낮은 성능 (R² < 0.5): 불순물-Ca, 자성이물-Cr
결론
ML 기반 피팅 함수가 우수: Gradient Boosting이 모든 타겟에서 최적
파라미터 기반 함수는 한계: Rational, Sine, Polynomial 등은 R² 0.2~0.3 수준
타겟별 성능 차이: 불순물-Ca, 자성이물-Cr은 예측이 어려운 것으로 보임

----------------

모델 개선 1) 
기존 방식:
원재료 데이터를 그대로 사용
예: "조성-Ni = 45", "조성-Co = 4.26"
모델이 이 값들의 관계를 스스로 찾아야 함
도메인 특징 방식:
물리/화학 관계를 미리 계산해 제공
예: "Ni/Co 비율 = 45 / 4.26 = 10.57"
모델이 이 비율을 바로 사용
구체적인 예시

예시 2: 불순물-Na (현재 R² = 0.86, 좋음)
기존:
- 불순물-Na-MTRL-08.5 = 40.01

+ impurity_alkali_metals = 40.01 (새로 추가!)
  → 알칼리 금속 합 (Na)
+ composition_li_tm_ratio = 0.012 (새로 추가!)
  → 리튬/전이금속 비율
  
→ 상관계수 = 1.0 (완벽한 관계!)
→ 모델이 더 정확하게 예측 가능

예시 3: 자성이물-합계 (현재 R² = 0.20, 낮음)
도메인 특징 활용:
기존:
- 자성이물-Fe = 0.76
- 자성이물-Cr = 0.20

+ magnetic_total = 0.76 + 0.20 = 0.96 (새로 추가!)
  → 총 자성이물 합
  
→ 상관계수 = 1.0 (완벽!)
→ 모델이 "총 자성이물 합"을 바로 사용하여 예측

작동 원리
1단계: 도메인 특징 생성 (이미 완료)
원재료 데이터  ↓물리/화학 관계 계산  ↓도메인 특징 42개 생성
예시:
조성-Ni = 45.03, 조성-Co = 4.26
→ composition_ni_co_ratio = 45.03 / 4.26 = 10.57 생성
2단계: 모델 학습 시 특징 선택
모든 특징 (기존 159개 + 도메인 42개 = 201개)  ↓우선순위 특징 선택  ↓도메인 특징이 우선 선택됨! (상관계수가 높으니까)  ↓모델 학습
실제 예시:
불순물-Ca 예측 시:
impurity_alkaline_earth (도메인) ← 상관계수 1.0, 우선 선택
impurity_total (도메인) ← 상관계수 높음, 선택
기존 특징들...
3단계: 성능 개선
기존: 불순물-Ca, R² = -0.14  → 특징-타겟 상관계수 최대 0.27 (낮음)  → 모델이 관계를 찾지 못함도메인 특징 사용: 불순물-Ca, R² = ? (개선 기대)  → impurity_alkaline_earth와 상관계수 1.0 (완벽!)  → 모델이 관계를 바로 찾음
왜 효과가 있을까?
1. 상관계수가 매우 높음
분석 결과:
불순물-Ca ↔ impurity_alkaline_earth: 상관계수 1.0
불순물-Na ↔ impurity_alkali_metals: 상관계수 1.0
자성이물-합계 ↔ magnetic_total: 상관계수 1.0
→ 모델이 관계를 바로 학습 가능
2. 의미 있는 관계 직접 제공
기존: 모델이 "조성-Ni와 조성-Co의 관계"를 찾아야 함도메인: "Ni/Co 비율"을 직접 제공 → 모델이 바로 사용
3. 저성능 타겟 개선 가능
불순물-Ca:- 기존: 상관계수 최대 0.27 → R² = -0.14- 도메인: 상관계수 1.0 → R² 개선 기대!
실제 작동 과정
모델 학습 시:
특징 선택:
   타겟: 불순물-Ca      우선순위 특징 확인:   ✓ impurity_alkaline_earth (도메인) ← 상관계수 1.0, 선택!   ✓ impurity_total (도메인) ← 선택!   ✓ 기존 특징들...      최종: 8개 특징 (도메인 2개 + 기존 6개)
모델 학습:
   입력: [impurity_alkaline_earth=2.19, impurity_total=2056, ...]   출력: 불순물-Ca 예측값      모델이 학습:   "알칼리 토금속 합이 2.19면 → Ca는 약 1.70"
성능 평가:
   Test 세트에서 예측   → R² 계산   → 기존 -0.14보다 높으면 성공!
기대 효과
성공 시나리오:
불순물-Ca:- 기존 R²: -0.14 (매우 나쁨)- 도메인 특징 사용 후: R² = 0.5~0.7 (대폭 개선!)이유:- impurity_alkaline_earth와 상관계수 1.0- 모델이 관계를 바로 학습
평균 성능:
현재 평균 R²: 0.3273도메인 특징 사용 후: 0.4~0.5 목표이유:- 저성능 타겟들이 개선되면 평균도 올라감
요약
도메인 특징 = 물리/화학 관계를 미리 계산한 특징
예시:
기존: "Ca = 1.70, Mg = 0.49" (별개 값)
도메인: "알칼리 토금속 합 = 2.19" (의미 있는 합)
효과:
상관계수가 높아 모델이 관계를 쉽게 학습
특히 저성능 타겟에서 개선 기대
모델 해석이 쉬워짐
결과:
평균 R²: 0.33 → 0.4 이상 목표
불순물-Ca: -0.14 → 0.5 이상 목표

적용된 개선 사항 2) 
1. 특징 선택 개선
MAX_FEATURES: 8 → 12 (상한선 증가)
타겟별 동적 특징 수 결정 함수 추가 (determine_feature_count)
상관관계가 높으면 더 많이 선택 (최대 12개)
상관관계가 낮으면 적게 선택 (최소 5개)
2. 정규화 강화
reg_alpha: [0, 0.1] → [0, 0.1, 0.5, 1.0, 2.0]
reg_lambda: [0.5, 1.0] → [0.5, 1.0, 1.5, 2.0, 3.0]
gamma: [0, 0.1] → [0, 0.1, 0.2]
3. 하이퍼파라미터 튜닝 개선
XGB_FINE_TUNING_N_ITER: 100 → 150
4. 타겟 필터링 개선
상관관계 >= 0.3인 타겟만 추가로 필터링
산포 분석 + 상관관계 두 조건 모두 만족하는 타겟만 학습
예상 효과
현재 평균 R²: 0.3577
예상 평균 R²: 0.45 ~ 0.55
예상 향상: +0.10 ~ +0.20
























